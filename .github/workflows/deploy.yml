# .github/workflows/deploy.yml
name: Deploy Freelance Lena Bot

on:
  push:
    branches: [main, master]
  workflow_dispatch: # ÐŸÐ¾Ð·Ð²Ð¾Ð»ÑÐµÑ‚ Ð·Ð°Ð¿ÑƒÑÐºÐ°Ñ‚ÑŒ Ð²Ñ€ÑƒÑ‡Ð½ÑƒÑŽ

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: ðŸ“¦ Checkout code
        uses: actions/checkout@v4

      - name: ðŸš€ Deploy to server
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.HOST }}
          username: ${{ secrets.USERNAME }}
          key: ${{ secrets.SSH_KEY }}
          port: ${{ secrets.PORT }}
          script: |
            echo "ðŸ§¹ ÐÐ°Ñ‡Ð¸Ð½Ð°ÐµÐ¼ Ð¿Ð¾Ð»Ð½ÑƒÑŽ Ð¿ÐµÑ€ÐµÑƒÑÑ‚Ð°Ð½Ð¾Ð²ÐºÑƒ Ð±Ð¾Ñ‚Ð°..."

            # ÐžÑÑ‚Ð°Ð½Ð°Ð²Ð»Ð¸Ð²Ð°ÐµÐ¼ ÑÑ‚Ð°Ñ€Ñ‹Ð¹ ÑÐµÑ€Ð²Ð¸Ñ
            sudo systemctl stop freelance-bot || true
            sudo systemctl disable freelance-bot || true

            # ÐŸÐ¾Ð»Ð½Ð¾ÑÑ‚ÑŒÑŽ ÑƒÐ´Ð°Ð»ÑÐµÐ¼ ÑÑ‚Ð°Ñ€ÑƒÑŽ Ð´Ð¸Ñ€ÐµÐºÑ‚Ð¾Ñ€Ð¸ÑŽ
            sudo rm -rf /opt/freelance_lena_bot
            sudo rm -f /etc/systemd/system/freelance-bot.service
            sudo systemctl daemon-reload

            # Ð¡Ð¾Ð·Ð´Ð°ÐµÐ¼ Ñ‡Ð¸ÑÑ‚ÑƒÑŽ Ð´Ð¸Ñ€ÐµÐºÑ‚Ð¾Ñ€Ð¸ÑŽ
            sudo mkdir -p /opt/freelance_lena_bot
            cd /opt/freelance_lena_bot

            # ÐšÐ»Ð¾Ð½Ð¸Ñ€ÑƒÐµÐ¼ ÑÐ²ÐµÐ¶Ð¸Ð¹ ÐºÐ¾Ð´ Ð¸Ð· Ñ€ÐµÐ¿Ð¾Ð·Ð¸Ñ‚Ð¾Ñ€Ð¸Ñ
            sudo git clone https://github.com/${{ github.repository }}.git .

            # Ð¡Ð¾Ð·Ð´Ð°ÐµÐ¼ .env Ñ„Ð°Ð¹Ð» Ñ Ñ‚Ð¾ÐºÐµÐ½Ð¾Ð¼
            sudo tee .env > /dev/null <<EOF
            BOT_TOKEN=${{ secrets.BOT_TOKEN }}
            DEBUG=False
            EOF

            # Ð¡Ð¾Ð·Ð´Ð°ÐµÐ¼ Ð²Ð¸Ñ€Ñ‚ÑƒÐ°Ð»ÑŒÐ½Ð¾Ðµ Ð¾ÐºÑ€ÑƒÐ¶ÐµÐ½Ð¸Ðµ
            python3 -m venv venv
            source venv/bin/activate

            # Ð£ÑÑ‚Ð°Ð½Ð°Ð²Ð»Ð¸Ð²Ð°ÐµÐ¼ Ð·Ð°Ð²Ð¸ÑÐ¸Ð¼Ð¾ÑÑ‚Ð¸
            pip install --upgrade pip
            pip install -r requirements.txt

            # Ð¡Ð¾Ð·Ð´Ð°ÐµÐ¼ Ð½ÐµÐ¾Ð±Ñ…Ð¾Ð´Ð¸Ð¼Ñ‹Ðµ Ð´Ð¸Ñ€ÐµÐºÑ‚Ð¾Ñ€Ð¸Ð¸
            mkdir -p data logs images/main images/directions images/courses

            # ÐŸÑ€Ð¾Ð²ÐµÑ€ÑÐµÐ¼ Ñ‡Ñ‚Ð¾ Ð²ÑÐµ Ñ„Ð°Ð¹Ð»Ñ‹ Ð½Ð° Ð¼ÐµÑÑ‚Ðµ
            echo "ðŸ“ ÐŸÑ€Ð¾Ð²ÐµÑ€ÑÐµÐ¼ ÑÑ‚Ñ€ÑƒÐºÑ‚ÑƒÑ€Ñƒ:"
            ls -la
            echo "ðŸ“ Ð¡Ð¾Ð´ÐµÑ€Ð¶Ð¸Ð¼Ð¾Ðµ data/:"
            ls -la data/

            # ÐŸÑ€Ð¾Ð²ÐµÑ€ÑÐµÐ¼ Ñ‡Ñ‚Ð¾ directions.json ÑÑƒÑ‰ÐµÑÑ‚Ð²ÑƒÐµÑ‚
            if [ ! -f "data/directions.json" ]; then
              echo "âŒ Ð¤Ð°Ð¹Ð» directions.json Ð½Ðµ Ð½Ð°Ð¹Ð´ÐµÐ½ Ð² data/"
              # Ð•ÑÐ»Ð¸ Ñ„Ð°Ð¹Ð» Ð² ÐºÐ¾Ñ€Ð½Ðµ - ÐºÐ¾Ð¿Ð¸Ñ€ÑƒÐµÐ¼ ÐµÐ³Ð¾
              if [ -f "directions.json" ]; then
                cp directions.json data/
                echo "âœ… Ð¡ÐºÐ¾Ð¿Ð¸Ñ€Ð¾Ð²Ð°Ð»Ð¸ directions.json Ð² data/"
              else
                echo "âŒ ÐšÐ Ð˜Ð¢Ð˜Ð§Ð•Ð¡ÐšÐÐ¯ ÐžÐ¨Ð˜Ð‘ÐšÐ: directions.json Ð½Ðµ Ð½Ð°Ð¹Ð´ÐµÐ½!"
                exit 1
              fi
            fi

            # Ð¢ÐµÑÑ‚Ð¸Ñ€ÑƒÐµÐ¼ Ð¼Ð¾Ð´ÑƒÐ»Ð¸ Python
            echo "ðŸ§ª Ð¢ÐµÑÑ‚Ð¸Ñ€ÑƒÐµÐ¼ Python Ð¼Ð¾Ð´ÑƒÐ»Ð¸..."
            python3 -c "
            import sys
            sys.path.append('.')
            try:
                from utils.data_loader import load_directions
                from handlers import start, directions, courses, earning_ways, common
                from keyboards import get_main_menu
                from states import UserStates

                directions = load_directions()
                print(f'âœ… Ð’ÑÐµ Ð¼Ð¾Ð´ÑƒÐ»Ð¸ Ð·Ð°Ð³Ñ€ÑƒÐ¶ÐµÐ½Ñ‹ ÑƒÑÐ¿ÐµÑˆÐ½Ð¾')
                print(f'âœ… ÐÐ°Ð¹Ð´ÐµÐ½Ð¾ Ð½Ð°Ð¿Ñ€Ð°Ð²Ð»ÐµÐ½Ð¸Ð¹: {len(directions)}')

            except Exception as e:
                print(f'âŒ ÐžÑˆÐ¸Ð±ÐºÐ°: {e}')
                import traceback
                traceback.print_exc()
                exit(1)
            "

            # Ð£ÑÑ‚Ð°Ð½Ð°Ð²Ð»Ð¸Ð²Ð°ÐµÐ¼ Ð¿Ñ€Ð°Ð²Ð° Ð´Ð¾ÑÑ‚ÑƒÐ¿Ð°
            sudo chown -R root:root /opt/freelance_lena_bot/
            sudo chmod +x bot.py

            # Ð£ÑÑ‚Ð°Ð½Ð°Ð²Ð»Ð¸Ð²Ð°ÐµÐ¼ systemd ÑÐµÑ€Ð²Ð¸Ñ
            sudo cp freelance-bot.service /etc/systemd/system/
            sudo systemctl daemon-reload
            sudo systemctl enable freelance-bot

            # Ð—Ð°Ð¿ÑƒÑÐºÐ°ÐµÐ¼ Ð±Ð¾Ñ‚Ð°
            sudo systemctl start freelance-bot

            # ÐŸÑ€Ð¾Ð²ÐµÑ€ÑÐµÐ¼ ÑÑ‚Ð°Ñ‚ÑƒÑ
            sleep 5
            sudo systemctl status freelance-bot --no-pager

            # ÐŸÐ¾ÐºÐ°Ð·Ñ‹Ð²Ð°ÐµÐ¼ Ð¿Ð¾ÑÐ»ÐµÐ´Ð½Ð¸Ðµ Ð»Ð¾Ð³Ð¸
            echo "ðŸ“‹ ÐŸÐ¾ÑÐ»ÐµÐ´Ð½Ð¸Ðµ Ð»Ð¾Ð³Ð¸:"
            sudo journalctl -u freelance-bot --lines=10 --no-pager

            echo "ðŸŽ‰ Ð”ÐµÐ¿Ð»Ð¾Ð¹ Ð·Ð°Ð²ÐµÑ€ÑˆÐµÐ½!"
