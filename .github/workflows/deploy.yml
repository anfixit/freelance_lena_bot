name: Deploy Freelance Bot

on:
  push:
    branches: [main]
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Stop old bot service
        uses: appleboy/ssh-action@v0.1.10
        with:
          host: ${{ secrets.HOST }}
          username: ${{ secrets.USERNAME }}
          key: ${{ secrets.SSH_KEY }}
          script: |
            echo "üõë –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Å—Ç–∞—Ä—ã–π —Å–µ—Ä–≤–∏—Å..."
            sudo systemctl stop freelance-bot || true
            sudo systemctl disable freelance-bot || true

      - name: Clean old installation
        uses: appleboy/ssh-action@v0.1.10
        with:
          host: ${{ secrets.HOST }}
          username: ${{ secrets.USERNAME }}
          key: ${{ secrets.SSH_KEY }}
          script: |
            echo "üßπ –£–¥–∞–ª—è–µ–º —Å—Ç–∞—Ä—ã–µ —Ñ–∞–π–ª—ã..."
            sudo rm -rf /opt/freelance_lena_bot
            sudo rm -f /etc/systemd/system/freelance-bot.service
            sudo systemctl daemon-reload

            echo "üìÅ –°–æ–∑–¥–∞–µ–º —á–∏—Å—Ç—É—é –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—é..."
            sudo mkdir -p /opt/freelance_lena_bot
            sudo chown -R root:root /opt/freelance_lena_bot

      - name: Copy ALL files via scp
        uses: appleboy/scp-action@v0.1.7
        with:
          host: ${{ secrets.HOST }}
          username: ${{ secrets.USERNAME }}
          key: ${{ secrets.SSH_KEY }}
          source: "."
          target: "/opt/freelance_lena_bot"
          strip_components: 0
          rm: true

      - name: Setup and start bot
        uses: appleboy/ssh-action@v0.1.10
        with:
          host: ${{ secrets.HOST }}
          username: ${{ secrets.USERNAME }}
          key: ${{ secrets.SSH_KEY }}
          script: |
            cd /opt/freelance_lena_bot

            echo "üìÅ –ü—Ä–æ–≤–µ—Ä—è–µ–º —á—Ç–æ —Å–∫–æ–ø–∏—Ä–æ–≤–∞–ª–æ—Å—å:"
            ls -la

            echo "üñºÔ∏è –ü—Ä–æ–≤–µ—Ä—è–µ–º –ø–∞–ø–∫—É images:"
            ls -la images/ || echo "‚ùå –ü–∞–ø–∫–∞ images –Ω–µ –Ω–∞–π–¥–µ–Ω–∞!"

            echo "üìã –ü—Ä–æ–≤–µ—Ä—è–µ–º data/directions.json:"
            ls -la data/ || echo "‚ùå –ü–∞–ø–∫–∞ data –Ω–µ –Ω–∞–π–¥–µ–Ω–∞!"

            # –°–æ–∑–¥–∞–µ–º .env —Ñ–∞–π–ª –∏–∑ —Å–µ–∫—Ä–µ—Ç–æ–≤ GitHub
            echo "üîê –°–æ–∑–¥–∞–µ–º .env —Ñ–∞–π–ª..."
            cat > .env << EOF
            BOT_TOKEN=${{ secrets.BOT_TOKEN }}
            DATABASE_URL=${{ secrets.DATABASE_URL || 'sqlite:///bot.db' }}
            DEBUG=${{ secrets.DEBUG || 'False' }}
            ADMIN_IDS=${{ secrets.ADMIN_IDS || '' }}
            WEBHOOK_HOST=${{ secrets.WEBHOOK_HOST || '' }}
            WEBHOOK_PORT=${{ secrets.WEBHOOK_PORT || '8001' }}
            EOF

            echo "‚úÖ .env —Ñ–∞–π–ª —Å–æ–∑–¥–∞–Ω"

            # –ü—Ä–æ–≤–µ—Ä—è–µ–º Python 3.11
            if ! command -v python3.11 &> /dev/null; then
              echo "üì¶ –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º Python 3.11..."
              sudo apt update
              sudo apt install -y software-properties-common
              sudo add-apt-repository ppa:deadsnakes/ppa -y
              sudo apt update
              sudo apt install -y python3.11 python3.11-venv python3.11-dev python3.11-pip
            fi

            # –°–æ–∑–¥–∞–µ–º/–æ–±–Ω–æ–≤–ª—è–µ–º –≤–∏—Ä—Ç—É–∞–ª—å–Ω–æ–µ –æ–∫—Ä—É–∂–µ–Ω–∏–µ
            echo "üêç –°–æ–∑–¥–∞–µ–º –≤–∏—Ä—Ç—É–∞–ª—å–Ω–æ–µ –æ–∫—Ä—É–∂–µ–Ω–∏–µ..."
            sudo rm -rf venv
            python3.11 -m venv venv
            source venv/bin/activate

            # –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏
            echo "üì¶ –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏..."
            pip install --upgrade pip
            pip install -r requirements.txt

            # –°–æ–∑–¥–∞–µ–º –Ω–µ–¥–æ—Å—Ç–∞—é—â–∏–µ –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏
            mkdir -p logs

            # –¢–µ—Å—Ç–∏—Ä—É–µ–º –º–æ–¥—É–ª–∏ Python
            echo "üß™ –¢–µ—Å—Ç–∏—Ä—É–µ–º Python –º–æ–¥—É–ª–∏..."
            python3 -c "
            import sys
            sys.path.append('.')
            try:
                from utils.data_loader import load_directions
                from handlers import start, directions, courses, earning_ways, common
                from keyboards import get_main_menu
                from states import UserStates

                directions = load_directions()
                print(f'‚úÖ –í—Å–µ –º–æ–¥—É–ª–∏ –∑–∞–≥—Ä—É–∂–µ–Ω—ã —É—Å–ø–µ—à–Ω–æ')
                print(f'‚úÖ –ù–∞–π–¥–µ–Ω–æ –Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–π: {len(directions)}')

            except Exception as e:
                print(f'‚ùå –û—à–∏–±–∫–∞: {e}')
                import traceback
                traceback.print_exc()
                exit(1)
            " || exit 1

            # –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –ø—Ä–∞–≤–∞ –¥–æ—Å—Ç—É–ø–∞
            echo "üîê –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –ø—Ä–∞–≤–∞ –¥–æ—Å—Ç—É–ø–∞..."
            sudo chown -R root:root /opt/freelance_lena_bot/
            sudo chmod +x bot.py

            # –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º systemd —Å–µ—Ä–≤–∏—Å
            echo "‚öôÔ∏è –ù–∞—Å—Ç—Ä–∞–∏–≤–∞–µ–º systemd —Å–µ—Ä–≤–∏—Å..."
            sudo cp freelance-bot.service /etc/systemd/system/
            sudo systemctl daemon-reload
            sudo systemctl enable freelance-bot

            # –ó–∞–ø—É—Å–∫–∞–µ–º –±–æ—Ç–∞
            echo "‚ñ∂Ô∏è –ó–∞–ø—É—Å–∫–∞–µ–º –±–æ—Ç–∞..."
            sudo systemctl start freelance-bot

            # –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å—Ç–∞—Ç—É—Å
            echo "‚úÖ –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å—Ç–∞—Ç—É—Å —á–µ—Ä–µ–∑ 5 —Å–µ–∫—É–Ω–¥..."
            sleep 5
            sudo systemctl status freelance-bot --no-pager

            # –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –ø–æ—Å–ª–µ–¥–Ω–∏–µ –ª–æ–≥–∏
            echo "üìã –ü–æ—Å–ª–µ–¥–Ω–∏–µ –ª–æ–≥–∏:"
            sudo journalctl -u freelance-bot --lines=15 --no-pager

            echo ""
            echo "üéâ –î–µ–ø–ª–æ–π –∑–∞–≤–µ—Ä—à–µ–Ω!"
            echo "üì± –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –æ—Ç–ø—Ä–∞–≤–∏—Ç—å /start –±–æ—Ç—É"

      - name: Notify deployment status
        if: always()
        run: |
          if [ ${{ job.status }} == 'success' ]; then
            echo "‚úÖ –î–µ–ø–ª–æ–π —É—Å–ø–µ—à–µ–Ω!"
          else
            echo "‚ùå –û—à–∏–±–∫–∞ –¥–µ–ø–ª–æ—è!"
          fi
