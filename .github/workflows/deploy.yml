name: Deploy Freelance Bot

on:
  push:
    branches: [main]
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Copy files via scp
        uses: appleboy/scp-action@v0.1.7
        with:
          host: ${{ secrets.HOST }}
          username: ${{ secrets.USERNAME }}
          key: ${{ secrets.SSH_KEY }}
          source: "bot.py,config.py,constants.py,handlers/,keyboards/,states/,utils/,data/,requirements.txt,.env,freelance-bot.service"
          target: "/opt/freelance_lena_bot"
          strip_components: 0

      - name: Deploy and restart bot
        uses: appleboy/ssh-action@v0.1.10
        with:
          host: ${{ secrets.HOST }}
          username: ${{ secrets.USERNAME }}
          key: ${{ secrets.SSH_KEY }}
          script: |
            cd /opt/freelance_lena_bot

            # ÐŸÑ€Ð¾Ð²ÐµÑ€ÑÐµÐ¼ Python 3.11
            if ! command -v python3.11 &> /dev/null; then
              echo "Ð£ÑÑ‚Ð°Ð½Ð°Ð²Ð»Ð¸Ð²Ð°ÐµÐ¼ Python 3.11..."
              apt update
              apt install -y software-properties-common
              add-apt-repository ppa:deadsnakes/ppa -y
              apt update
              apt install -y python3.11 python3.11-venv python3.11-dev python3.11-pip
            fi

            # ÐžÑÑ‚Ð°Ð½Ð°Ð²Ð»Ð¸Ð²Ð°ÐµÐ¼ Ð±Ð¾Ñ‚Ð°
            systemctl stop freelance-bot || true

            # Ð¡Ð¾Ð·Ð´Ð°ÐµÐ¼/Ð¾Ð±Ð½Ð¾Ð²Ð»ÑÐµÐ¼ Ð²Ð¸Ñ€Ñ‚ÑƒÐ°Ð»ÑŒÐ½Ð¾Ðµ Ð¾ÐºÑ€ÑƒÐ¶ÐµÐ½Ð¸Ðµ
            rm -rf venv
            python3.11 -m venv venv
            source venv/bin/activate

            # Ð£ÑÑ‚Ð°Ð½Ð°Ð²Ð»Ð¸Ð²Ð°ÐµÐ¼ Ð·Ð°Ð²Ð¸ÑÐ¸Ð¼Ð¾ÑÑ‚Ð¸
            pip install --upgrade pip
            pip install -r requirements.txt

            # Ð¡Ð¾Ð·Ð´Ð°ÐµÐ¼ Ð´Ð¸Ñ€ÐµÐºÑ‚Ð¾Ñ€Ð¸Ð¸
            mkdir -p data logs

            # ÐŸÑ€Ð¾Ð²ÐµÑ€ÑÐµÐ¼ Ñ‡Ñ‚Ð¾ Ð²ÑÐµ ÑÐµÐºÑ€ÐµÑ‚Ñ‹ Ð¿ÐµÑ€ÐµÐ´Ð°Ð½Ñ‹
            echo "ðŸ” ÐŸÑ€Ð¾Ð²ÐµÑ€ÑÐµÐ¼ ÑÐµÐºÑ€ÐµÑ‚Ñ‹..."
            if [ -z "${{ secrets.BOT_TOKEN }}" ]; then
              echo "âŒ BOT_TOKEN Ð½Ðµ Ð·Ð°Ð´Ð°Ð½ Ð² ÑÐµÐºÑ€ÐµÑ‚Ð°Ñ… GitHub!"
              exit 1
            fi
            echo "âœ… Ð’ÑÐµ ÑÐµÐºÑ€ÐµÑ‚Ñ‹ Ð¿ÐµÑ€ÐµÐ´Ð°Ð½Ñ‹ ÐºÐ¾Ñ€Ñ€ÐµÐºÑ‚Ð½Ð¾"

            # Ð¡Ð¾Ð·Ð´Ð°ÐµÐ¼ .env Ñ„Ð°Ð¹Ð» Ð¸Ð· ÑÐµÐºÑ€ÐµÑ‚Ð¾Ð² GitHub
            cat > .env << EOF
            BOT_TOKEN=${{ secrets.BOT_TOKEN }}
            DATABASE_URL=${{ secrets.DATABASE_URL || 'sqlite:///bot.db' }}
            DEBUG=${{ secrets.DEBUG || 'False' }}
            ADMIN_IDS=${{ secrets.ADMIN_IDS || '' }}
            WEBHOOK_HOST=${{ secrets.WEBHOOK_HOST || '' }}
            WEBHOOK_PORT=${{ secrets.WEBHOOK_PORT || '8001' }}
            EOF

            echo "âœ… .env Ñ„Ð°Ð¹Ð» ÑÐ¾Ð·Ð´Ð°Ð½"

            # ÐžÐ±Ð½Ð¾Ð²Ð»ÑÐµÐ¼ systemd ÑÐµÑ€Ð²Ð¸Ñ
            cp freelance-bot.service /etc/systemd/system/
            systemctl daemon-reload

            # Ð£ÑÑ‚Ð°Ð½Ð°Ð²Ð»Ð¸Ð²Ð°ÐµÐ¼ Ð¿Ñ€Ð°Ð²Ð° Ð´Ð¾ÑÑ‚ÑƒÐ¿Ð°
            chown -R root:root /opt/freelance_lena_bot
            chmod +x bot.py

            # Ð—Ð°Ð¿ÑƒÑÐºÐ°ÐµÐ¼ Ð±Ð¾Ñ‚Ð°
            systemctl enable freelance-bot
            systemctl start freelance-bot

            # ÐŸÑ€Ð¾Ð²ÐµÑ€ÑÐµÐ¼ ÑÑ‚Ð°Ñ‚ÑƒÑ
            sleep 5
            systemctl status freelance-bot --no-pager

            # ÐŸÑ€Ð¾Ð²ÐµÑ€ÑÐµÐ¼ Ð»Ð¾Ð³Ð¸
            journalctl -u freelance-bot --since "1 minute ago" --no-pager

      - name: Notify deployment status
        if: always()
        run: |
          if [ ${{ job.status }} == 'success' ]; then
            echo "âœ… Ð”ÐµÐ¿Ð»Ð¾Ð¹ ÑƒÑÐ¿ÐµÑˆÐµÐ½!"
          else
            echo "âŒ ÐžÑˆÐ¸Ð±ÐºÐ° Ð´ÐµÐ¿Ð»Ð¾Ñ!"
          fi
