# .github/workflows/deploy.yml
name: Deploy Freelance Lena Bot

on:
  push:
    branches: [main, master]
  workflow_dispatch: # Позволяет запускать вручную

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: 📦 Checkout code
        uses: actions/checkout@v4

      - name: 🚀 Deploy to server
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.HOST }}
          username: ${{ secrets.USERNAME }}
          key: ${{ secrets.SSH_KEY }}
          port: ${{ secrets.PORT }}
          script: |
            echo "🧹 Начинаем полную переустановку бота..."

            # Останавливаем старый сервис
            sudo systemctl stop freelance-bot || true
            sudo systemctl disable freelance-bot || true

            # Полностью удаляем старую директорию
            sudo rm -rf /opt/freelance_lena_bot
            sudo rm -f /etc/systemd/system/freelance-bot.service
            sudo systemctl daemon-reload

            # Создаем чистую директорию
            sudo mkdir -p /opt/freelance_lena_bot
            cd /opt/freelance_lena_bot

            # Клонируем свежий код из репозитория
            sudo git clone https://github.com/${{ github.repository }}.git .

            # Создаем .env файл с токеном
            sudo tee .env > /dev/null <<EOF
            BOT_TOKEN=${{ secrets.BOT_TOKEN }}
            DEBUG=False
            EOF

            # Создаем виртуальное окружение
            python3 -m venv venv
            source venv/bin/activate

            # Устанавливаем зависимости
            pip install --upgrade pip
            pip install -r requirements.txt

            # Создаем необходимые директории
            mkdir -p data logs images/main images/directions images/courses

            # Проверяем что все файлы на месте
            echo "📁 Проверяем структуру:"
            ls -la
            echo "📁 Содержимое data/:"
            ls -la data/

            # Проверяем что directions.json существует
            if [ ! -f "data/directions.json" ]; then
              echo "❌ Файл directions.json не найден в data/"
              # Если файл в корне - копируем его
              if [ -f "directions.json" ]; then
                cp directions.json data/
                echo "✅ Скопировали directions.json в data/"
              else
                echo "❌ КРИТИЧЕСКАЯ ОШИБКА: directions.json не найден!"
                exit 1
              fi
            fi

            # Тестируем модули Python
            echo "🧪 Тестируем Python модули..."
            python3 -c "
            import sys
            sys.path.append('.')
            try:
                from utils.data_loader import load_directions
                from handlers import start, directions, courses, earning_ways, common
                from keyboards import get_main_menu
                from states import UserStates

                directions = load_directions()
                print(f'✅ Все модули загружены успешно')
                print(f'✅ Найдено направлений: {len(directions)}')

            except Exception as e:
                print(f'❌ Ошибка: {e}')
                import traceback
                traceback.print_exc()
                exit(1)
            "

            # Устанавливаем права доступа
            sudo chown -R root:root /opt/freelance_lena_bot/
            sudo chmod +x bot.py

            # Устанавливаем systemd сервис
            sudo cp freelance-bot.service /etc/systemd/system/
            sudo systemctl daemon-reload
            sudo systemctl enable freelance-bot

            # Запускаем бота
            sudo systemctl start freelance-bot

            # Проверяем статус
            sleep 5
            sudo systemctl status freelance-bot --no-pager

            # Показываем последние логи
            echo "📋 Последние логи:"
            sudo journalctl -u freelance-bot --lines=10 --no-pager

            echo "🎉 Деплой завершен!"
